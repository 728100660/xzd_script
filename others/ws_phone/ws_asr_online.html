<!DOCTYPE html>
<html>
  <body>
    <h3>ğŸ™ï¸ å®æ—¶ASRæµ‹è¯•</h3>
    <button id="start">å¼€å§‹å½•éŸ³</button>
    <button id="stop">åœæ­¢å½•éŸ³</button>
    <pre id="log"></pre>

    <script>
      const ws = new WebSocket("ws://localhost:8000/ws/asr/test1");
      const log = (t) => (document.getElementById("log").textContent += t + "\n");
      let recorder, audioStream;

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === "text") log("è¯†åˆ«ä¸­: " + msg.data);
        if (msg.type === "final_text") log("æœ€ç»ˆç»“æœ: " + msg.data);
      };

      document.getElementById("start").onclick = async () => {
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const context = new AudioContext({ sampleRate: 8000 });
        log("ğŸ¤ é‡‡æ ·ç‡ï¼š" + context.sampleRate);
        const source = context.createMediaStreamSource(audioStream);
        const processor = context.createScriptProcessor(4096, 1, 1);
        source.connect(processor);
        processor.connect(context.destination);

        processor.onaudioprocess = (e) => {
          const inputData = e.inputBuffer.getChannelData(0);
          const pcm16 = new Int16Array(inputData.length);
          for (let i = 0; i < inputData.length; i++) {
            pcm16[i] = Math.max(-1, Math.min(1, inputData[i])) * 0x7fff;
          }
          const base64Data = btoa(
            String.fromCharCode(...new Uint8Array(pcm16.buffer))
          );
          ws.send(JSON.stringify({ type: "audio", data: base64Data }));
        };
        log("ğŸ¤ å¼€å§‹å½•éŸ³...");
      };

      document.getElementById("stop").onclick = () => {
        if (audioStream) audioStream.getTracks().forEach((t) => t.stop());
        ws.send(JSON.stringify({ type: "end" }));
        log("ğŸ›‘ åœæ­¢å½•éŸ³");
      };
    </script>
  </body>
</html>
