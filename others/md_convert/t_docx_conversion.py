#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
测试 docx 转换功能，验证中文编码问题是否解决
"""

import sys
import os

# 添加项目路径
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from core.tools.provider.builtin.md_convert.tools.md_convert import html_to_docx

def chinese_content():
    """测试包含中文内容的转换"""
    
    # 测试用的中文内容
    test_html = """
<p>以下是根据您提供的建筑方案目录生成的详细“施工测量专项方案”。我严格保持了原有的目录结构不变，每个章节均使用Markdown格式进行组织，确保文章的可读性。内容基于真实的建筑工程实践，采用了专业术语（如GPS静态测量、全站仪放样、沉降观测点等），并参考了国家标准《工程测量规范》GB 50026-2020 和典型项目案例（如某高层住宅项目）。方案力求真实可靠，涵盖了人员、设备、技术细节，以及精度控制和安全措施。</p>
<h2>整个方案以Markdown格式呈现，使用标题层级（# 用于章标题，## 用于节标题，- 用于列表）来增强结构清晰度。目录顺序与输入完全一致：从第一章到第八章，未做任何改动。每个章节的内容包括详细段落，确保专业性和实用性。</h2>
<h1>施工测量专项方案</h1>
<h2>第一章 编制依据</h2>
<p>本方案依据国家现行规范、项目设计文件及施工合同要求编制，确保测量工作的合规性和准确性。主要编制依据包括：
- <strong>国家及行业规范</strong>：<br />
  - 《工程测量规范》GB 50026-2020，规定了测量精度、方法和质量控制要求。<br />
  - 《建筑变形测量规范》JGJ 8-2016，适用于沉降观测和变形监测。<br />
- <strong>设计文件</strong>：<br />
  - 项目施工图纸（图号：A-01至A-50），包括总平面图、基础图和结构详图，提供坐标系统和高程基准。<br />
  - 技术说明书（编号：TS-2024-001），明确了测量控制点的布设原则和误差允许值。<br />
- <strong>合同及管理文件</strong>：<br />
  - 施工合同（编号：CON-2024-005），规定测量成果的提交时限和验收标准。<br />
  - 公司内部《测量作业指导书》（版本2.0），细化了人员培训和仪器管理流程。<br />
- <strong>其他依据</strong>：<br />
  - 场地地质勘察报告（编号：GEO-2024-010），提供地形起伏数据，影响控制网布设。<br />
  - 业主提供的城市坐标系（如北京54坐标系），作为测量基准的统一参考。  </p>
<p>本方案确保所有依据文件均为最新有效版本，并在施工前进行复核，以避免偏差。</p>
<h2>第二章 工程测量概况</h2>
<p>本工程为某城市高层住宅项目（项目名称：绿城雅苑），总建筑面积约12万平方米，包括两栋30层塔楼和配套商业裙楼。测量工作覆盖全周期，从场地平整至竣工验收，具有以下概况特点：
- <strong>工程规模与位置</strong>：<br />
  - 场地面积约1.5公顷，位于城市中心区（坐标：东经116.4°，北纬39.9°），地形相对平坦，但周边有既有建筑物，需避免测量干扰。<br />
  - 测量范围包括基坑开挖（深度8m）、主体结构（高度100m）、精装修工程及沉降观测，总测量点位数预计超过200个。<br />
- <strong>测量任务与特点</strong>：<br />
  - 主要任务：建立场区控制网、实施分部分项工程放样（如轴线定位）、监测变形（如基坑边坡位移），并确保装修阶段的空间精度。<br />
  - 特点分析：场地狭小，需高精度测量（平面误差≤5mm，高程误差≤3mm）；高层结构需竖向传递控制点；沉降观测周期长（施工期至竣工后2年）。<br />
- <strong>挑战与对策</strong>：<br />
  - 挑战：城市环境电磁干扰多，影响GPS信号；雨季施工需防设备受潮。<br />
  - 对策：采用抗干扰GPS设备，并制定雨季测量预案。  </p>
<p>本概况基于现场踏勘和设计交底，为后续测量工作提供基础框架。</p>
<h2>第三章 测量施工准备（人员、设备、技术）</h2>
<p>测量施工准备是确保工作高效、准确的基础，分为人员、设备和技术的系统配置。所有准备均遵循公司质量管理体系，并在开工前7天完成。
- <strong>人员准备</strong>：<br />
  - 配备专业测量团队：1名注册测量工程师（负责方案审核和精度控制）、3名测量技术员（持证上岗，负责现场操作）、2名辅助工（负责设备搬运和记录）。人员均经年度培训，熟悉应急预案。<br />
  - 职责分工：工程师主导技术交底；技术员执行放样和监测；辅助工确保现场安全。团队每日晨会协调进度。<br />
- <strong>设备准备</strong>：<br />
  - 关键仪器清单：<br />
    - 全站仪（型号：Leica TS16，精度：±2″，用于坐标放样和角度测量）。<br />
    - GPS接收机（型号：Trimble R10，支持RTK技术，用于控制点快速定位）。<br />
    - 数字水准仪（型号：Sokkia SDL30，精度：±0.5mm/km，用于高程传递）。<br />
    - 辅助工具：钢尺（50m，经检定）、对中杆、棱镜组及数据采集器。<br />
  - 设备管理：所有仪器均持有有效检定证书（见第八章），存储在干燥箱内；每日使用前进行校准，并记录在《仪器使用日志》。<br />
- <strong>技术准备</strong>：<br />
  - 技术流程：基于设计图纸，使用AutoCAD Civil 3D软件进行数据预处理（如坐标转换）；制定《测量作业指导书》，包括控制网布设方法和误差分配。<br />
  - 培训与交底：施工前组织全员技术交底，模拟现场场景（如基坑放样演练）；使用BIM模型验证关键点坐标，确保与设计一致。  </p>
<p>准备阶段强调“人机料法环”协调，杜绝未准备就绪即开工。</p>
<h2>第四章 场区控制网测设</h2>
<p>场区控制网是测量的基准框架，需优先测设以确保后续工程精度。本工程采用二级控制网系统（一级为整体控制，二级为局部加密），依据《工程测量规范》GB 50026-2020执行。
- <strong>布设原则</strong>：<br />
  - 一级控制网：布设6个强制对中标志点（材质：不锈钢），点间距约80-100m，覆盖全场区；点位选在稳固地面（避开回填区），并设防护桩。<br />
  - 二级控制网：在一级网基础上加密，点间距30-50m，用于分部分项工程；采用导线网形式，确保闭合差≤1/20000。<br />
- <strong>测设方法</strong>：<br />
  - 测量技术：一级网使用GPS静态测量（观测时段≥2小时，采样率15s），结合已知城市控制点（如点GCP-01），解算WGS-84坐标系坐标，精度要求±5mm。二级网采用导线测量（使用全站仪测角和测距），进行平差计算（软件：科傻平差）。<br />
  - 步骤流程：1) 现场踏勘选点；2) GPS观测和数据下载；3) 数据处理（剔除粗差）；4) 成果验收（提交坐标报告）。<br />
- <strong>质量控制</strong>：<br />
  - 测设中执行“三检制”（自检、互检、专检），闭合差控制在内控标准内；遇大风天气暂停作业，防止误差累积。最终成果绘制成控制网布置图（见第八章）。  </p>
<p>本测设确保控制点坐标误差≤±3mm，为工程提供可靠的空间基准。</p>
<h2>第五章 主要分部分项工程测量方法</h2>
<p>本工程测量按分部分项实施，针对基坑、主体、装修和沉降观测采用差异化方法。所有方法均基于控制网，使用高精度仪器，确保施工各阶段衔接顺畅。
- <strong>基坑工程测量</strong>：<br />
  - 方法：开挖前，使用全站仪放样基坑边界线（依据设计坐标），设置位移监测点（间距10m）。开挖中，每日监测边坡位移（精度±3mm），采用极坐标法；遇异常（如位移＞10mm），立即预警。回填后，复测基底标高（用水准仪），确保平整度≤5mm。<br />
- <strong>主体结构测量</strong>：<br />
  - 方法：采用“内控法”，在±0.000楼板预留测量孔（孔径100mm），使用激光铅垂仪（型号：Leica LN180）传递轴线至各楼层。每层施工时，放样柱墙位置（误差≤5mm），并复核梁板标高（数字水准仪测量）。高层竖向累计误差控制≤H/10000（H为建筑高度）。<br />
- <strong>装修工程测量</strong>：<br />
  - 方法：依据主体控制点，使用全站仪进行室内空间定位（如隔墙轴线）；地面平整度测量采用电子水准仪和2m靠尺（允许偏差±2mm）；精装修阶段，用激光扫平仪确保吊顶水平。所有测量数据实时录入BIM系统比对设计。<br />
- <strong>沉降观测</strong>：<br />
  - 方法：在建筑物四角和核心筒设置8个沉降观测点（埋设深1m），采用精密水准仪（型号：Sokkia SDL30）进行闭合水准测量。观测频率：施工期每层完成一次，竣工后每季度一次；精度要求±1mm。数据经平差分析，生成沉降曲线图，用于评估结构安全。  </p>
<p>各分项测量均编制详细作业指导书，强调与施工进度同步。</p>
<h2>第六章 测量精度控制及质量保证措施</h2>
<p>精度控制是测量的核心，本工程执行严格的质量保证体系，确保所有成果满足规范要求（平面位置误差≤5mm，高程误差≤3mm）。
- <strong>精度控制措施</strong>：<br />
  - 误差来源管理：针对仪器误差（如全站仪轴系误差），每日开工前进行校准；环境误差（如温度变化），使用温度补偿功能；人为误差，实行双人观测制度（一人操作，一人记录）。<br />
  - 关键控制点：控制网平差后闭合差≤1/20000；主体放样执行“放样-复核”循环，偏差超限时立即重测。<br />
- <strong>质量保证措施</strong>：<br />
  - 过程控制：采用PDCA循环，计划阶段制定《测量精度计划》；执行中实时数据比对（如与设计坐标）；检查阶段专检员抽查10%点位；处理问题根源。<br />
  - 具体方法：仪器定期检定（周期6个月，见第八章证书）；数据管理使用电子手簿（软件：Survey Pro），避免手工录入错误；成果验收由第三方检测机构抽检。<br />
  - 应急预案：如遇设备故障，启用备用仪器；数据异常时，溯源至控制点重新测量。  </p>
<p>质量目标：测量成果一次验收合格率≥98%，支撑工程整体质量创优。</p>
<h2>第七章 测量管理措施及安全注意事项</h2>
<p>测量管理确保工作有序高效，安全措施预防事故。本工程结合ISO 9001标准，制定以下措施。
- <strong>管理措施</strong>：<br />
  - 组织管理：设立测量组长负责制，每日编制《测量日报》（包括进度、问题和整改）；周例会协调与土建施工的接口。<br />
  - 流程管理：测量前申请作业令；数据实时上传云平台（如BIM 360）；记录保存至竣工档案，确保可追溯。<br />
  - 沟通机制：与监理和业主每月联合巡查，使用微信工作群实时反馈偏差。<br />
- <strong>安全注意事项</strong>：<br />
  - 通用安全：所有人员穿戴反光背心、安全帽和安全鞋；高处作业（如屋顶测量）系挂安全带，并设警戒区。<br />
  - 设备安全：仪器搬运使用专用箱；避免在雷雨或强风天气操作GPS；电池充电远离易燃物。<br />
  - 现场风险防控：基坑测量时，保持与开挖机械安全距离（≥5m）；夜间作业配备充足照明。安全预案包括急救培训和消防演练。  </p>
<p>管理目标：零事故率，测量延误率≤2%。</p>
<h2>第八章 附图（控制网布置图、仪器检定证书）</h2>
<p>本章为方案附图部分，提供关键可视化支持，确保测量成果的透明性和可验证性。具体附图如下：
- <strong>控制网布置图</strong>（图号：CN-2024-001）：<br />
  - 内容：展示一级和二级控制点位置、坐标及相互关系；包括场地边界、既有建筑参考点。图纸比例1:500，基于AutoCAD绘制，附坐标数据表。<br />
- <strong>仪器检定证书</strong>（证书编号列表）：<br />
  - 全站仪：检定证书（编号：CAL-2024-005，有效期至2024-12-31），由省级计量院签发。<br />
  - GPS接收机：检定证书（编号：CAL-2024-006，有效期至2024-12-31），符合JJG 100-2003标准。<br />
  - 数字水准仪：检定证书（编号：CAL-2024-007，有效期至2024-12-31），包括精度测试报告。  </p>
<p>所有附图均为方案附件，施工中可随时调阅；电子版存档于项目服务器。</p>
<hr />
<p>本方案严格遵循目录结构生成，内容基于工程实践，确保专业性和可操作性。如有调整需求，请基于此框架细化。', 'reasoning_content': '首先，用户要求我根据给定的目录生成详细的建筑方案。目录是结构化的JSON格式：{"序号":"3";"方案类型":"施工测量专项方案";"目录":"第一章 编制依据\
第二章 工程测量概况\
第三章 测量施工准备（人员、设备、技术）\
第四章 场区控制网测设\
第五章 主要分部分项工程测量方法（基坑、主体、装修、沉降观测）\
第六章 测量精度控制及质量保证措施\
第七章 测量管理措施及安全注意事项\
第八章 附图（控制网布置图、仪器检定证书）"}
关键点是：保持原本目录不变，填入具体段落内容。我需要确保输出的内容使用相同的章节结构。</p>
<p>用户指定了输出格式：尽量使用Markdown格式，整个文章具有可读性。所以，我应该用Markdown来组织内容，比如使用标题、列表等。</p>
<p>内容要求：尽量真实可靠，注意使用专业术语。作为建筑工程师，我需要生成一个施工测量专项方案。方案应该基于建筑工程的实际情况，使用专业术语如GPS、全站仪、水准仪、控制点、坐标等。</p>
<p>目录结构：</p>
<ol>
<li>
<p>第一章 编制依据</p>
</li>
<li>
<p>第二章 工程测量概况</p>
</li>
<li>
<p>第三章 测量施工准备（人员、设备、技术）</p>
</li>
<li>
<p>第四章 场区控制网测设</p>
</li>
<li>
<p>第五章 主要分部分项工程测量方法（基坑、主体、装修、沉降观测）</p>
</li>
<li>
<p>第六章 测量精度控制及质量保证措施</p>
</li>
<li>
<p>第七章 测量管理措施及安全注意事项</p>
</li>
<li>
<p>第八章 附图（控制网布置图、仪器检定证书）</p>
</li>
</ol>
<p>我需要为每个章节撰写详细内容。保持目录不变，所以输出中应该先列出目录，然后填充内容。</p>
<p>用户说："保持原本目录不变，填入具体段落内容。" 所以，在输出中，我应该包括目录作为标题，然后添加内容。</p>
<p>在Markdown中，我可以使用标题如# 第一章 编制依据，然后写段落。
最后强调：保持原本目录结构不变。所以，输出顺序必须和输入目录一致。</p>
<p>现在，规划每个章节的内容：</p>
<ul>
<li>
<p><strong>第一章 编制依据</strong>：这应该列出方案编制的依据，如国家规范、行业标准、设计文件等。例如：</p>
</li>
<li>
<p>《工程测量规范》GB 50026-2020</p>
</li>
<li>
<p>项目设计图纸</p>
</li>
<li>
<p>相关施工合同</p>
</li>
<li>
<p>公司内部标准</p>
</li>
<li>
<p><strong>第二章 工程测量概况</strong>：描述项目的测量概况，如项目位置、规模、测量范围和特点。例如：</p>
</li>
<li>
<p>项目名称：某住宅小区</p>
</li>
<li>
<p>建筑面积：10万平方米</p>
</li>
<li>
<p>测量范围：包括场地平整、基坑开挖、主体结构、装修等</p>
</li>
<li>
<p>特点：地形复杂，需要高精度测量</p>
</li>
<li>
<p><strong>第三章 测量施工准备（人员、设备、技术）</strong>：分为人员、设备、技术三部分。</p>
</li>
<li>
<p>人员：测量工程师、技术人员、操作员等</p>
</li>
<li>
<p>设备：全站仪、GPS接收机、水准仪、钢尺等</p>
</li>
<li>
<p>技术：使用CAD软件、测量数据处理方法</p>
</li>
<li>
<p><strong>第四章 场区控制网测设</strong>：建立控制网的方法，如布设控制点、使用GPS或导线测量。</p>
</li>
<li>
<p>布设原则：均匀分布、稳固点</p>
</li>
<li>
<p>方法：静态GPS测量、闭合导线</p>
</li>
<li>
<p><strong>第五章 主要分部分项工程测量方法</strong>：分基坑、主体、装修、沉降观测。</p>
</li>
<li>
<p>基坑：土方开挖测量、边坡监测</p>
</li>
<li>
<p>主体：轴线放样、高程控制</p>
</li>
<li>
<p>装修：室内定位、平整度测量</p>
</li>
<li>
<p>沉降观测：定期观测建筑物沉降</p>
</li>
<li>
<p><strong>第六章 测量精度控制及质量保证措施</strong>：确保精度的措施，如仪器校准、数据复核、误差控制。</p>
</li>
<li>
<p>精度要求：根据规范</p>
</li>
<li>
<p>措施：双人复核、使用高精度仪器</p>
</li>
<li>
<p><strong>第七章 测量管理措施及安全注意事项</strong>：管理流程和安全措施。</p>
</li>
<li>
<p>管理：测量计划、记录保存</p>
</li>
<li>
<p>安全：佩戴安全帽、避免高处坠落</p>
</li>
<li>
<p><strong>第八章 附图</strong>：列出附图，如控制网布置图和仪器检定证书。在实际输出中，由于是文本   我可以说“见附图”，但不能实际包含图。</p>
</li>
</ul>
<p>用户说：“第八章 附图（控制网布置图、仪器检定证书）”，所以在内容中，我应该描述或提及这些图。</p>
<p>现在，确保内容真实可靠：使用标准术语和实际场景。假设一个典型建筑项目。</p>
<p>输出格式：用Markdown。所以，使用# for章节标题，## for子标题，- for列表等。
整个文章结构：我应该以目录开始，但用户说“保持原本目录不变”，所以可能直接进入章节内容。</p>
<p>或许在开头列出目录，然后填充内容。</p>
<p>为了清晰，我可以这样：</p>
<ul>
<li>先写一个标题，如“施工测量专项方案”</li>
<li>然后按章节顺序写。</li>
</ul>
<p>在Markdown中：</p>
<h1>施工测量专项方案</h1>
<p>然后</p>
<h2>第一章 编制依据</h2>
<p>内容...</p>
<h2>第二章 工程测量概况</h2>
<p>等等。</p>
<p>用户给的目录中有“序号":"3"，但我不需要包括序号，只关注目录内容。
最后，内容要详细：每个章节至少写几个段落，确保充实。</p>
<p>长度：用户没有指定，但既然是详细方案，每个章节写100-200字左右。</p>
<p>确保可读性：使用清晰语言，避免冗长。</p>
<p>现在，脑补内容：</p>
<ul>
<li>
<p><strong>第一章 编制依据</strong>：</p>
</li>
<li>
<p>本方案依据国家相关规范、设计文件及项目实际情况编制。</p>
</li>
<li>
<p>主要依据包括：</p>
<ul>
<li>《工程测量规范》GB 50026-2020</li>
<li>
<p>项目施工图纸及技术说明</p>
</li>
<li>
<p>合同文件及业主要求</p>
</li>
<li>
<p>公司质量管理体系文件</p>
</li>
</ul>
</li>
<li>
<p><strong>第二章 工程测量概况</strong>：</p>
</li>
<li>
<p>项目名称：XX城市综合体项目</p>
</li>
<li>
<p>工程概况：总建筑面积约15万平方米，包括2栋高层住宅和商业裙楼。场地地形平坦，但周边有建筑物，需精确测量。</p>
</li>
<li>
<p>测量任务：包括场地控制网建立、基坑监测、主体结构放样、装修定位及沉降观测等。</p>
</li>
<li>
<p><strong>第三章 测量施工准备</strong>：</p>
</li>
<li>
<p><strong>人员准备</strong>：配备测量工程师2名，技术员4名，均持证上岗。</p>
</li>
<li>
<p><strong>设备准备</strong>：使用全站仪（型号：Leica TS16）、GPS接收机（Trimble R10）、数字水准仪、钢尺等，所有设备均经检定合格。</p>
</li>
<li>
<p><strong>技术准备</strong>：熟悉图纸，制定测量方案，使用AutoCAD进行数据处理。</p>
</li>
<li>
<p><strong>第四章 场区控制网测设</strong>：</p>
</li>
<li>
<p>布设原则：在场区设置一级控制网，点间距约100米，采用强制对中标志。</p>
</li>
<li>
<p>测设方法：使用GPS静态测量进行控制点坐标测定，精度要求±5mm。然后布设二级导线网。</p>
</li>
<li>
<p><strong>第五章 主要分部分项工程测量方法</strong>：</p>
</li>
<li>
<p><strong>基坑工程测量</strong>：开挖前放样边界线，监测边坡位移，使用全站仪进行坐标测量。</p>
</li>
<li>
<p><strong>主体结构测量</strong>：采用内控法，在楼板上预留测量孔，使用激光铅垂仪传递轴线。</p>
</li>
<li>
<p><strong>装修工程测量</strong>：室内墙面、地面平整度测量，使用水准仪和靠尺。</p>
</li>
<li>
<p><strong>沉降观测</strong>：在建筑物关键位置设置沉降点，每层施工完成后观测一次，使用精密水准仪。</p>
</li>
<li>
<p><strong>第六章 测量精度控制及质量保证措施</strong>：</p>
</li>
<li>
<p>精度控制：根据规范，平面位置误差≤5mm，高程误差≤3mm。</p>
</li>
<li>
<p>质量措施：仪器定期检定、测量数据双人复核、记录完整保存。</p>
</li>
<li>
<p><strong>第七章 测量管理措施及安全注意事项</strong>：</p>
</li>
<li>
<p>管理措施：制定测量计划、日报制度、问题及时反馈。</p>
</li>
<li>
<p>安全注意事项：测量人员穿戴安全装备，避免在危险区域作业，如基坑边缘。</p>
</li>
<li>
<p><strong>第八章 附图</strong>：</p>
</li>
<li>
<p>本方案附有：</p>
<ul>
<li>
<p>控制网布置图（图号：MW-01）</p>
</li>
<li>
<p>仪器检定证书复印件</p>
</li>
</ul>
</li>
</ul>
<p>在输出中，对于第八章，由于是文本，可以说“详见附图”，而不实际画图。</p>
<p>现在，编写完整输出。</p>
    """
    import time
    print("测试原始 html2docx 方法...")
    start_time = time.time()
    try:
        result1 = html_to_docx(test_html)
        with open("test_original.docx", "wb") as f:
            f.write(result1)
        print("✓ 原始方法成功生成 test_original.docx")
    except Exception as e:
        print(f"✗ 原始方法失败: {e}")
    print(f"time1: {time.time() - start_time}")

    print("\n测试改进的 html2docx 方法...")
    start_time = time.time()
    try:
        result2 = html_to_docx(test_html)
        with open("test_improved.docx", "wb") as f:
            f.write(result2)
        print("✓ 改进方法成功生成 test_improved.docx")
    except Exception as e:
        print(f"✗ 改进方法失败: {e}")
    print(f"time1: {time.time() - start_time}")

if __name__ == "__main__":
    chinese_content()
    print("\n测试完成！请检查生成的 docx 文件在 Word 中的显示效果。")
